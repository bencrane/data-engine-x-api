# Architecture

## System Flow (Current)

The active runtime path is:

1. **v1 execute engine** via `POST /api/v1/execute` for canonical `operation_id`.
2. **Batch orchestration** via `POST /api/v1/batch/submit` creating one `submissions` row and root `pipeline_runs`.
3. **Pipeline execution** in Trigger.dev `run-pipeline`.
4. **Fan-out parent/child runs** when a step enables fan-out (child runs created with `parent_pipeline_run_id` and resumed at `start_from_position`).
5. **Entity state accumulation** in `company_entities` / `person_entities` after succeeded runs.
6. **Entity timeline writes** in `entity_timeline` for upserts and fan-out discovery events.
7. **Batch status aggregation** via `POST /api/v1/batch/status` including parent runs, child runs, and final context.

## Execute Engine (v1)

- Supported operations are declared in `app/routers/execute_v1.py`.
- Each operation resolves to a specific `execute_*` service function.
- Results are persisted in:
  - `operation_runs`
  - `operation_attempts`
- Entity type constraints are enforced for request payloads:
  - `person.*` requires `entity_type=person`
  - `company.*` requires `entity_type=company`

## Output Chaining (Cumulative Context)

- Initial input context is `blueprint_snapshot.entity.input` (or submission fallback).
- For each succeeded step, Trigger merges `result.output` into `cumulative_context`.
- Next step receives full merged context.
- `step_results.output_payload` stores both:
  - `operation_result`
  - `cumulative_context`

This is the active data handoff model across all operation steps.

## Fan-Out Model (Parent/Child Runs)

- A step can enable fan-out (`fan_out` flag).
- Trigger extracts entities from operation output (`output.results`) and calls `/api/internal/pipeline-runs/fan-out`.
- FastAPI creates child runs with:
  - `parent_pipeline_run_id` set to the source run
  - copied/merged parent context + discovered entity input
  - step rows starting from `start_from_position`
- Parent run can complete while child runs continue.
- Batch status groups children under root run in `runs[].children`.

## Per-Step Entity Type Derivation

Trigger derives each step execution `entity_type` from `operation_id` prefix:

- `person.*` -> `person`
- everything else -> `company`

Implementation is in `trigger/src/tasks/run-pipeline.ts` (`entityTypeFromOperationId`).

## Entity State Accumulation

Trigger calls `/api/internal/entity-state/upsert` after a pipeline run succeeds.

- `entity_type=company` -> `upsert_company_entity(...)`
- `entity_type=person` -> `upsert_person_entity(...)`

Key behavior:

- Versioned writes via `record_version`
- stale-write protection
- canonical columns plus `canonical_payload`
- `entity_id` resolved from context or generated by resolver functions

## Entity Timeline

Timeline events are written through `app/services/entity_timeline.py`:

- From `/api/internal/entity-state/upsert` after operation completion.
- From `/api/internal/pipeline-runs/fan-out` for:
  - company fan-out discovery summary
  - per-person discovered child-run event

Timeline rows include operation/provider/status/fields metadata and run lineage.

## Trigger.dev <-> FastAPI Communication Pattern

Communication is internal HTTP with service auth:

1. FastAPI creates submissions/runs/steps and triggers Trigger task.
2. Trigger calls internal endpoints (`/api/internal/*`) using:
   - `Authorization: Bearer <INTERNAL_API_KEY>`
3. Trigger calls `/api/v1/execute` with:
   - `Authorization: Bearer <INTERNAL_API_KEY>`
   - `x-internal-org-id`
   - `x-internal-company-id`
4. FastAPI persists step/run/submission/entity updates.

This is the only active orchestration boundary between runtimes.

## Secrets Flow: Doppler -> Docker -> Railway

- `Dockerfile` installs Doppler CLI and runs app with `doppler run -- uvicorn ...`.
- Runtime config in Python uses non-prefixed env names (for example `DATABASE_URL`, `INTERNAL_API_KEY`).
- Railway stores `DOPPLER_TOKEN` only; Doppler injects all other secrets at container start.
- Trigger runtime still supports `DATA_ENGINE_API_URL` / `DATA_ENGINE_INTERNAL_API_KEY` fallback for task execution.

## Legacy Step Executor (Not Used by Current Pipeline Runner)

`trigger/src/tasks/execute-step.ts` and generic HTTP `steps.*` executor config remain in the codebase for backward compatibility.

Current pipeline execution does **not** use this path. Active execution uses operation-native `blueprint_steps.operation_id` and `POST /api/v1/execute`.

## Failure Semantics

- Fail-fast per run:
  - failed step -> run failed
  - remaining queued steps -> skipped
- Submission status is synced from child/root run statuses.
- If entity upsert fails after run success, run is flipped to failed.
